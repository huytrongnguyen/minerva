{
  "sources": [{
    "type": "csv",
    "options": {
      "header": "true"
    },
    "location": "{{targets.warehouse.location}}/{{product_id}}/appsflyer/in_app_events_report/app_id={{vars.app_ids}}/event_date={{event_date}}"
  }],
  "targets": [{
    "partition_by": ["event_date"],
    "location": "{{targets.warehouse.location}}/{{product_id}}/reporting/in_app_events",
    "columns": [
      {"name": "product_id", "funcs": ["set(product_id)"]},
      {"name": "event_time", "funcs": ["to_date"], "alias": "event_date"},
      {"name": "af_prt", "alias": "agency"},
      {"name": "media_source"},
      {"name": "af_c_id", "alias": "campaign_id"},
      {"name": "country_code", "funcs": ["upper"]},
      {"name": "platform", "funcs": ["lower"]},
      {"name": "event_name"},
      {"name": "event_source"},
      {"name": "customer_user_id"},
      {"name": "appsflyer_id"}
    ],
    "query": ["where(event_date is not null and event_name is not null)","fillna(na,agency,media_source,campaign_id,country_code,platform)"],
    "aggregation": {
      "type": "group_by",
      "dimensions": ["product_id","event_date","agency","media_source","campaign_id","country_code","platform","event_name"],
      "measures": [
        {"name": "unique_users", "funcs": ["count_distinct(appsflyer_id)"]},
        {"name": "unique_installs", "funcs": ["count_distinct(appsflyer_id)"]},
        {"name": "total_events", "funcs": ["count(event_date)"]}
      ]
    }
  }]
}
{
  "sources": [{
    "type": "csv",
    "options": {
      "header": "true"
    },
    "location": "{{targets.warehouse.location}}/{{product_id}}/appsflyer/in_app_events_report/app_id={{vars.app_ids}}/event_date={{event_date}}"
  }],
  "targets": [{
    "partition_by": ["event_date"],
    "location": "{{targets.warehouse.location}}/{{product_id}}/users/complete_registration",
    "columns": [
      {"name": "product_id", "funcs": ["set(product_id)"]},
      {"name": "install_time", "funcs": ["cast(timestamp)"]},
      {"name": "event_time", "funcs": ["cast(timestamp)"]},
      {"name": "event_date", "funcs": ["col(event_time)","to_date"]},
      {"name": "af_prt"},
      {"name": "media_source"},
      {"name": "af_c_id"},
      {"name": "country_code", "funcs": ["upper"]},
      {"name": "platform", "funcs": ["lower"]},
      {"name": "event_name"},
      {"name": "appsflyer_id"},
      {"name": "customer_user_id", "alias": "user_id"}
    ],
    "query": ["where(event_name = 'af_role_create')"],
    "aggregation": {
      "type": "partition_by",
      "order_by": ["event_time"],
      "dimensions": ["product_id","event_date","user_id"],
      "measures": [
        {"name": "install_time", "funcs": ["first(install_time)"]},
        {"name": "register_time", "funcs": ["first(event_time)"]},
        {"name": "agency", "funcs": ["first(af_prt)"]},
        {"name": "media_source", "funcs": ["first(media_source)"]},
        {"name": "campaign_id", "funcs": ["first(af_c_id)"]},
        {"name": "country_code", "funcs": ["first(country_code)"]},
        {"name": "platform", "funcs": ["first(platform)"]},
        {"name": "install_id", "funcs": ["first(appsflyer_id)"]}
      ]
    }
  }, {
    "partition_by": ["event_date"],
    "location": "{{targets.warehouse.location}}/{{product_id}}/users/login",
    "columns": [
      {"name": "product_id", "funcs": ["set(product_id)"]},
      {"name": "event_time"},
      {"name": "event_date", "funcs": ["col(event_time)","to_date"]},
      {"name": "event_name"},
      {"name": "customer_user_id", "alias": "user_id"}
    ],
    "query": ["where(event_name = 'af_login_success' and user_id is not null)"],
    "aggregation": {
      "type": "group_by",
      "dimensions": ["product_id","event_date","user_id"],
      "measures": [
        {"name": "first_login_time", "funcs": ["min(event_time)"]},
        {"name": "last_login_time", "funcs": ["max(event_time)"]},
        {"name": "session_count", "funcs": ["count(event_time)"]}
      ]
    }
  }, {
    "partition_by": ["event_date"],
    "location": "{{targets.warehouse.location}}/{{product_id}}/users/level",
    "columns": [
      {"name": "product_id", "funcs": ["set(product_id)"]},
      {"name": "event_time"},
      {"name": "event_date", "funcs": ["col(event_time)","to_date"]},
      {"name": "event_name"},
      {"name": "level", "funcs": ["col(event_name)","regexp_replace(af_level_,)","cast(int)"]},
      {"name": "customer_user_id", "alias": "user_id"}
    ],
    "query": ["where(event_name like 'af_level_%' and user_id is not null)"],
    "aggregation": {
      "type": "group_by",
      "dimensions": ["product_id","event_date","user_id"],
      "measures": [
        {"name": "level", "funcs": ["max(level)"]}
      ]
    }
  }, {
    "partition_by": ["event_date"],
    "location": "{{targets.warehouse.location}}/{{product_id}}/users/purchase",
    "columns": [
      {"name": "product_id", "funcs": ["set(product_id)"]},
      {"name": "event_time"},
      {"name": "event_date", "funcs": ["col(event_time)","to_date"]},
      {"name": "event_name"},
      {"name": "event_revenue_currency", "funcs": ["upper"]},
      {"name": "event_revenue", "funcs": ["cast(double)"]},
      {"name": "event_revenue_usd", "funcs": ["cast(double)"]},
      {"name": "customer_user_id", "alias": "user_id"}
    ],
    "query": ["where(event_name = 'af_purchase' and user_id is not null and event_revenue is not null)"],
    "aggregation": {
      "type": "group_by",
      "dimensions": ["product_id","event_date","user_id","event_revenue_currency"],
      "measures": [
        {"name": "first_payment_time", "funcs": ["min(event_time)"]},
        {"name": "last_payment_time", "funcs": ["max(event_time)"]},
        {"name": "revenue", "funcs": ["sum(event_revenue)"]},
        {"name": "revenue_usd", "funcs": ["sum(event_revenue_usd)"]},
        {"name": "number_of_payments", "funcs": ["count(event_time)"]}
      ]
    }
  }]
}